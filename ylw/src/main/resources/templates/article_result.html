<html
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:th="http://thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        layout:decorate="~{layout}">
<!-- form 안에 form이 들어가면 안되는데 지금 망함-->
<div layout:fragment="content" class="main-content-container container-fluid px-4">

    <!--/*<div>*/-->
    <h1>결과 페이지</h1>
    <hr>
    <h3 th:text="${article.title}"></h3>
    <h5 th:text="${article.content}"></h5>
    <hr>

    <!--/*    댓글 form*/-->
    <h2>댓글</h2>

    <form sec:authorize="isAuthenticated()" th:action="@{|/comment/create/${article.getId()}|}" th:object="${commentForm}" method="post">
        <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
            <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea th:field="*{content}" class="form-control" rows="10" placeholder="내용을 입력하세요." ></textarea>
        </div>
        <input type="submit" value="저장하기" class="btn btn-primary my-2">
    </form>

    <!--/*   비회원용 댓글 form*/-->
    <form sec:authorize="isAnonymous()" th:action="@{|/comment/non-create/${article.getId()}|}" th:object="${nonMemberCommentForm}" method="post">
        <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
            <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
        </div>

        <div>
            임시 닉네임 :
            <input type="text" name="tempNickname" />
        </div>
        <div>
            임시 비밀번호 :
            <input type="password" name="tempPassword"  />
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea th:field="*{content}" class="form-control" rows="10" placeholder="내용을 입력하세요." ></textarea>
        </div>
        <input type="submit" value="저장하기" class="btn btn-primary my-2">
    </form>

    <!--/*
        =======================
        =======================
        댓글 목록
        아래 공사중
        https://www.thewordcracker.com/jquery-examples/how-to-add-specific-content-to-html-using-jquery/
        https://wangtak.tistory.com/27 제이쿼리에 태그추가에 변수넣는법
        일반 버튼들 보이는거 구성
        태그 추가가능여부
        form애들도 꾸며줘
        =======================
        =======================
    */-->

    <!-- Discussions Component -->
    <div class="col-lg-8 col-md-12 col-sm-12 mb-4">
        <div class="card card-small blog-comments">
            <div class="card-header border-bottom">
                <h6 class="m-0">댓글</h6>
            </div>

            <div th:each="comment : ${commentList}" class="card-body p-0">
                <div class="blog-comments__item  p-3">
                    <div class="blog-comments__avatar d-flex justify-content-between mr-3">
                        <div class="item d-flex">
                            <div th:if="${comment.author != null}" th:text="${comment.author.getNickname()}" class="font-weight-bold">익명</div>
                            <div th:if="${comment.tempNickname != null}" th:text="${comment.getTempNickname()}" class="font-weight-bold">익명</div>
                            <div th:text="${#temporals.format(comment.getCreatedDate, 'yyyy-MM-dd HH:mm:ss')}" class="small text-muted ml-2 mt-1">1 분전</div>
                            <div th:text="${comment.getModifiedDate()}" class="d-none"></div>
                            <!--/*
                                    ==========================
                                       회원이 보는 댓글 view
                                    ==========================
                            */-->
                            <div th:if="${comment.author != null}" class="d-inline">
                                <a th:if="${#authentication.name == comment.author.getMemberId()}" href="javascript:void(0);" th:myContent="${comment.content}" th:onclick="createCommentModifyForm(event, this.getAttribute('myContent'))"  type="button" class="btn-link pl-1 comment-modify-toggle">
                                    <span class="text-success">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    수정
                                </a>
                                <a th:if="${#authentication.name == comment.author.getMemberId()}" th:href="@{|/comment/delete/${comment.id}|}" type="button" class="btn-link">
                                    <span class="text-light">
                                        <i class="material-icons">delete</i>
                                    </span>
                                    삭제
                                </a>
                            </div>
                            <!--/*
                                    ==========================
                                       비회원이 보는 댓글 view
                                    ==========================
                            */-->
                            <div th:if="${#authentication.name == 'anonymousUser'}"  class="d-inline">
                                <a href="javascript:void(0);" class="btn-link pl-1 non-comment-modify-toggle">
                                    <span class="text-success">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    수정
                                </a>
                                <a type="button" class="btn-link non-comment-modify-toggle">
                                    <span class="text-light">
                                        <i class="material-icons">delete</i>
                                    </span>
                                    삭제
                                </a>
                                <div class="d-none">
                                    <div>
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" disabled/>
                                        <input type="hidden" name="tempNickname" th:value="${comment.tempNickname}" disabled/>
                                        <input type="password" name="tempPassword" value="" placeholder="비밀번호를 입력해주세요"  required>
                                    </div>
                                    <div>
                                        <a th:id="check-+${comment.id}">확인</a>
                                        <a typse="button">취소</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <button th:if="${comment.author == null}" type="button" class="btn btn-white btn-sm">
                                    <span class="text-danger">
                                        <i class="material-icons">report</i>
                                    </span>
                                신고
                            </button>
                            <th:block th:unless="${comment.author == null}">
                                <button th:if="${#authentication.name != comment.author.getMemberId()}" type="button" class="btn btn-white btn-sm">
                                    <span class="text-danger">
                                        <i class="material-icons">report</i>
                                    </span>
                                    신고
                                </button>
                            </th:block>

                        </div>
                    </div>
                    <div class="blog-comments__content ml-3">
                        <!--/*회원*/-->
                        <form th:if="${#authentication.name != 'anonymousUser'}" th:action="@{|/comment/modify/${comment.id}|}"  method="post">
                            <p class="m-0 my-1 mb-2 font-weight-light" >[[${comment.content}]]</p>
                        </form>
                        <!--/*비회원*/-->
                        <form th:if="${#authentication.name == 'anonymousUser'}" th:action="@{|/comment/non-modify/${comment.id}|}"  method="post" novalidate>
                            <p class="m-0 my-1 mb-2 font-weight-light" >[[${comment.content}]]</p>
                        </form>
                    </div>
                </div>
            </div>


            <div class="card-footer border-top">
                <div class="row">
                    <div class="col text-center view-report">
                        <button type="submit" class="btn btn-white">여기에 페이징</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Discussions Component -->
</div>


</html>

<!--/*script은 html에 밖에서 써줘야 동작합니다*/-->

<script>
    /**
     *  회원 수정 폼 클릭시 이벤트
     */
    // 태그 생성을 위한 섧정
    const commentModifyLayout = `<div id='modify-from-group' class='form-group p-absolute'>
                                <textarea class='form-control' name='content' rows='3' required></textarea>
                                <input type='submit' class='mb-2 btn btn-sm btn-primary mr-1 mt-1' value='수정완료'/>
                                <button type='button' class='mb-2 btn btn-sm btn-secondary mr-1 mt-1' onclick='clearCommentModifyForm()' >취소</button>
                              </div>`;
    const commentModifyTag = document.createElement('div');
    commentModifyTag.innerHTML = commentModifyLayout;
    let commentModifyBtn = '';
    // 수정 폼 생성
    function createCommentModifyForm(event, content) {
        commentModifyBtn = event.target // 수정 버튼
        commentModifyBtn.classList.toggle('d-none');

        commentModifyTag.querySelector('.form-control').innerHTML = content;
        const commentModifyForm = event.target.closest('.blog-comments__item').children[1].children[0]; //form 위치
        commentModifyForm.children[1].classList.toggle("d-none"); //기존 내용 안 보이게
        commentModifyForm.append(commentModifyTag); // form 위치에 textarea 추가

    }
    // 수정 폼 취소 버튼 이벤트
    function clearCommentModifyForm() {
        commentModifyBtn.classList.toggle('d-none'); // 수정 버튼 다시 보이게
        commentModifyTag.previousElementSibling.classList.toggle('d-none'); //p태그 다시 보이게
        commentModifyTag.remove(); // form 제거
    }

    /**
     * 비회원 수정, 삭제 유효성 체크
     */

    function createCommentValidForm(event, commentId, method) {


    }
    document.querySelectorAll(".check-comment-owner").forEach((item) => {

        item.addEventListener('click', () => {
            const methodAndCommentId = item.getAttribute('id').split('-');
            const method = methodAndCommentId[0];
            const commentId = methodAndCommentId[1];

            const tempNickname = item.closest('div').previousElementSibling.children[1].value;
            const tempPassword = item.closest('div').previousElementSibling.children[2].value;

            const token = item.closest('div').previousElementSibling.children[0].value;
            fetch(`/comment/non-${method}/${commentId}`, {
                // credentials: 'include',
                method: "POST",
                body : JSON.stringify({
                    tempNickname : tempNickname,
                    tempPassword : tempPassword
                }),
                headers: {
                    "Content-Type": "application/json",
                    'X-CSRF-Token': token  // 필수! 안 해주면 "403 forbidden" 오류
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.result === "success") {
                        switch (method) {
                            case "check":
                                item.closest('form').children[2].classList.toggle("d-none"); // 수정버튼 숨김
                                item.closest('.toast-undo').classList.toggle("d-none");      // toast 숨김
                                item.closest('form').children[1].classList.toggle("d-none"); // 수정form 활성화
                                break;
                            case "delete":
                                alert("댓글이 삭제되었습니다.");
                                location.reload();
                                break;
                            default :
                                alert("잘못된 접근입니다.")
                        }
                    } else if (data.result === "failure") {
                        alert("비밀번호가 틀렸습니다.");
                        item.closest('div').previousElementSibling.children[2].value = "";
                    }
                })
                .catch(err => {
                    alert(err);
                });
        })
    })

    /**
     *  비회원 수정 폼 클릭시 이벤트
     */
    const nonCommentModifyBtnList = document.querySelectorAll(".non-comment-modify-toggle");


    // 수정 버튼 클릭시 toggle 형식으로 toast를 화면에 보이게 함
    // 다른 수정 폼, 혹은 toast를 제외한 화면 클릭시 toast없앰
    window.addEventListener('click', (e) => {
        nonCommentModifyBtnList.forEach((item) => {
            const toast = item.nextElementSibling; // 다음 요소 toast

            // 클릭 위치가 toast이면 취소
            if (e.target.closest('.toast-undo')) {
                return ;
            } else if (e.target.closest('.toast-form')) {
                return ;
            } else if (e.target.closest('.toast-btn')) {
                return ;
            }
            // 다른 toast 안 보이게 none처리함
            if (!toast.classList.contains("d-none")){
                toast.classList.add("d-none");
            }
            // 클릭 위치가 버튼이면 toast 화면에 보이게 함
            if(e.target == item) {
                toast.classList.remove("d-none");
            }
        })
    });
    // 비번 클릭 창 취소
    document.querySelectorAll(".comment-pwd-cancel").forEach((item) => {
        item.addEventListener('click', () => {
            const div = item.closest('.toast-undo') // 두 번째 조상
            div.classList.toggle("d-none"); // toast 숨겨줌
        })
    })
</script>