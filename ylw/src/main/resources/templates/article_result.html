<html
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:th="http://thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        layout:decorate="~{layout}">
<!-- form 안에 form이 들어가면 안되는데 지금 망함-->
<div layout:fragment="content" class="main-content-container container-fluid px-4">

    <!--/*<div>*/-->
    <h1>결과 페이지</h1>
    <hr>
    <h3 th:text="${article.title}"></h3>
    <h5 th:text="${article.content}"></h5>
    <hr>

    <!--/*    댓글 form*/-->
    <h2>댓글</h2>

    <form sec:authorize="isAuthenticated()" th:action="@{|/comment/create/${article.getId()}|}" th:object="${commentForm}" method="post">
        <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
            <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea th:field="*{content}" class="form-control" rows="10" placeholder="내용을 입력하세요." ></textarea>
        </div>
        <input type="submit" value="저장하기" class="btn btn-primary my-2">
    </form>

    <!--/*   비회원용 댓글 form*/-->
    <form sec:authorize="isAnonymous()" th:action="@{|/comment/non-create/${article.getId()}|}" th:object="${nonMemberCommentForm}" method="post">
        <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
            <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
        </div>

        <div>
            임시 닉네임 :
            <input type="text" name="tempNickname" />
        </div>
        <div>
            임시 비밀번호 :
            <input type="password" name="tempPassword"  />
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea th:field="*{content}" class="form-control" rows="10" placeholder="내용을 입력하세요." ></textarea>
        </div>
        <input type="submit" value="저장하기" class="btn btn-primary my-2">
    </form>

    <!--/*
        =======================
        =======================
        댓글 목록
        아래 공사중
        =======================
        =======================
    */-->

    <!-- Discussions Component -->
    <div class="col-lg-8 col-md-12 col-sm-12 mb-4">
        <div class="card card-small blog-comments">
            <div class="card-header border-bottom">
                <h6 class="m-0">댓글</h6>
            </div>

            <div th:each="comment : ${commentList}" class="card-body p-0">
                <div class="blog-comments__item  p-3">
                    <div class="blog-comments__avatar d-flex justify-content-between mr-3">
                        <div class="item d-flex">
                            <!--/*회원 비회원 공통 부분 start*/-->
                            <div th:if="${comment.author != null}" th:text="${comment.author.getNickname()}" class="font-weight-bold">익명</div>
                            <div th:if="${comment.tempNickname != null}" th:text="${comment.getTempNickname()}" class="font-weight-bold">익명</div>
                            <div th:text="${#temporals.format(comment.getCreatedDate, 'yyyy-MM-dd HH:mm:ss')}" class="small text-muted ml-2 mt-1">1 분전</div>
                            <div th:text="${comment.getModifiedDate()}" class="d-none"></div>
                            <!--/*회원 비회원 공통 부분 end*/-->

                            <!--/*회원이 보는 댓글 버튼 start*/-->
                            <div th:if="${comment.author != null}" class="d-inline">
                                <a th:if="${#authentication.name == comment.author.getMemberId()}" href="javascript:void(0);" th:myContent="${comment.content}" th:onclick="createCommentModifyForm(event, this.getAttribute('myContent'))"  type="button" class="btn-link pl-1">
                                    <span class="text-success">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    수정
                                </a>
                                <a th:if="${#authentication.name == comment.author.getMemberId()}" th:href="@{|/comment/delete/${comment.id}|}" type="button" class="btn-link">
                                    <span class="text-light">
                                        <i class="material-icons">delete</i>
                                    </span>
                                    삭제
                                </a>
                            </div>
                            <!--/*회원이 보는 댓글 버튼 end*/-->

                            <!--/*비회원이 보는 댓글 버튼 start*/-->
                            <div th:if="${#authentication.name == 'anonymousUser'}"  class="d-inline">
                                <a href="javascript:void(0);" th:onclick="createCommentValidForm(event, 'check')" class="btn-link pl-1" >
                                    <span class="text-success">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    수정
                                </a>
                                <a href="javascript:void(0);" type="button" th:onclick="createCommentValidForm(event, 'delete')" class="btn-link"  >
                                    <span class="text-light">
                                        <i class="material-icons">delete</i>
                                    </span>
                                    삭제
                                </a>

                                <!--/*-->
                                        ==========================
                                               toast layout
                                        ==========================
                                <!--*/-->
<!--                                position: absolute; inset: 0px; overflow: hidden;-->
<!--                                pointer-events: none;-->
<!--                                visibility: hidden; z-index: -1;-->

                                <div class="toast-valid d-none bg-success position-absolute p-1 rounded shadow-sm">
                                    <div>
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" disabled/>
                                        <input type="hidden" name="tempNickname" th:value="${comment.tempNickname}" disabled/>
                                        <input type="password" name="tempPassword" value="" placeholder="비밀번호를 입력해주세요" class="form-control-sm input-sm" required>
                                    </div>
                                    <div class="btn-group-sm mt-1  float-right">
                                        <button type="button" class="btn btn-secondary border-0" th:myContent="${comment.content}" th:myId="${comment.id}" th:onclick="sendCommentValidForm(event, this.getAttribute('myContent'),this.getAttribute('myId'))">
                                            확인
                                        </button>
                                        <button type="button" onclick="nonClearCommentModifyForm()" class="btn btn-secondary border-0 text-center">취소</button>
                                    </div>
                                </div>
                            </div>
                            <!--/*비회원이 보는 댓글 버튼 end*/-->
                        </div>
                        <!--/*-->
                                ==========================
                                           신고
                                ==========================
                        <!--*/-->
                        <div class="item">
                            <!--/*비회원 댓글 모두 신고 표시*/-->
                            <button th:if="${comment.author == null}" type="button" class="btn btn-white btn-sm">
                                    <span class="text-danger">
                                        <i class="material-icons">report</i>
                                    </span>
                                    신고
                            </button>
                            <!--/*회원 댓글 중 본인 제외하고 모두 신고 표시*/-->
                            <th:block th:unless="${comment.author == null}">
                                <button th:if="${#authentication.name != comment.author.getMemberId()}" type="button" class="btn btn-white btn-sm">
                                    <span class="text-danger">
                                        <i class="material-icons">report</i>
                                    </span>
                                    신고
                                </button>
                            </th:block>
                        </div>
                    </div>
                    <!--/*-->
                            ==========================
                                    댓글 수정 폼
                            ==========================
                    <!--*/-->
                    <div class="blog-comments__content ml-3">
                        <!--/*회원 댓글 수정폼*/-->
                        <form th:if="${#authentication.name != 'anonymousUser'}" th:action="@{|/comment/modify/${comment.id}|}" method="post">
                            <p class="m-0 my-1 mb-2 font-weight-light" >[[${comment.content}]]</p>
                        </form>
                        <!--/*비회원 댓글 수정폼*/-->
                        <form th:if="${#authentication.name == 'anonymousUser'}" th:action="@{|/comment/non-modify/${comment.id}|}" method="post" novalidate>
                            <p class="m-0 my-1 mb-2 font-weight-light" >[[${comment.content}]]</p>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card-footer border-top">
                <div class="row">
                    <div class="col text-center view-report">
                        <button type="submit" class="btn btn-white">여기에 페이징</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Discussions Component -->
</div>


</html>

<!--/*script은 html에 밖에서 써줘야 동작합니다*/-->

<script>
    /**
     *  [회원] 관련 이벤트 코드
     */
    // 수정 form 내용물
    const commentModifyLayout = `<div id='modify-from-group' class='form-group p-absolute'>
                                <textarea class='form-control' name='content' rows='3' required></textarea>
                                <input type='submit' class='mb-2 btn btn-sm btn-primary mr-1 mt-1' value='수정완료'/>
                                <button type='button' class='mb-2 btn btn-sm btn-secondary mr-1 mt-1' onclick='clearCommentModifyForm()' >취소</button>
                              </div>`;
    const commentModifyTag = document.createElement('div');
    commentModifyTag.innerHTML = commentModifyLayout;

    let commentModifyBtn = '';  // 댓글 수정 버튼 태그

    // 댓글 수정 버튼 이벤트
    function createCommentModifyForm(event, content) {

        if (commentModifyBtn !== '') {
            // 이전 수정 버튼 보이게 설정
            commentModifyBtn.classList.remove('d-none');
        }
        commentModifyBtn = event.target                 // 수정 버튼
        commentModifyBtn.classList.toggle('d-none');    // 수정 버튼 숨김

        commentModifyTag.querySelector('.form-control').innerHTML = content;                                // textarea에 내용 넣어줌
        const commentModifyForm = commentModifyBtn.closest('.blog-comments__item').children[1].children[0]; // form 태그 가져오기
        commentModifyForm.children[1].classList.add("d-none");                                              // p태그 내용 안 보이게 설정
        commentModifyForm.append(commentModifyTag);                                                         // form 위치에 form 내용물 추가
    }
    // 댓글 수정폼 취소 버튼 이벤트
    function clearCommentModifyForm() {
        commentModifyBtn.classList.remove('d-none');                        // 수정 버튼 다시 보이게
        commentModifyTag.previousElementSibling.classList.toggle('d-none'); // p태그 다시 보이게
        commentModifyTag.remove();                                          // form 제거
    }

    /**
     * [비회원] 관련 이벤트 코드
     */
    let commentValidToast = ''; // toast 태그
    let commentValidMethod =''; // 수정 or 삭제 변수

    // 댓글 수정 버튼 이벤트
    function createCommentValidForm(event, method) {

        commentValidMethod = method;

        if (commentValidToast !== '') {
            // 이전 toast창 안 보이게 설정
            commentValidToast.classList.add('d-none');
        }

        commentValidToast = event.target.closest('div').lastElementChild  // toast창 가져옴
        commentValidToast.classList.toggle('d-none')                      // toast창 보이게 설정

        // 버튼 위치 조절
        if (method === 'delete') {
            commentValidToast.classList.add('ml-5')
        } else {
            commentValidToast.classList.remove('ml-5')
        }
    }

    // 비회원 수정 폼 생성
    function nonCreateCommentModifyForm(event, content) {

        if (commentModifyBtn !== '') {
            // 이전 수정버튼 보이게 설정
            commentModifyBtn.classList.remove('d-none');
        }

        commentModifyBtn = event.target.closest('.d-inline').firstElementChild  // 수정 버튼 가져옴
        commentModifyBtn.classList.toggle('d-none');                            // 수정 버튼 안 보이게 설정

        // createCommentModifyForm메서드와 동일
        commentModifyTag.querySelector('.form-control').innerHTML = content;
        const commentModifyForm = commentModifyBtn.closest('.blog-comments__item').children[1].children[0];
        commentModifyForm.children[1].classList.add("d-none");
        commentModifyForm.append(commentModifyTag);
    }
    // toast 창 취소 버튼 이벤트
    function nonClearCommentModifyForm() {
        commentValidToast.classList.add('d-none');
    }
    // toast 창 확인 버튼 이벤트
    function sendCommentValidForm(event, content, commentId) {
        if (commentValidMethod === ''){
            return;
        }
        const validForm = event.target.closest('.toast-valid').firstElementChild;  // toast form 가져옴
        const token = validForm.children[0].value;                                 // token 값 가져옴
        const tempNickname = validForm.children[1].value;                          // tempNickname 값 가져옴
        const tempPassword = validForm.children[2].value;                          // tempPassword 값 가져옴

        if (tempPassword == '') {
            alert('비밀번호를 입력세주세요');
            return;
        }
        // method 여부에 따라서 check 또는 delete 요청을 보낸다.
        fetch(`/comment/non-${commentValidMethod}/${commentId}`, {
            // credentials: 'include',
            method: "POST",
            body : JSON.stringify({
                tempNickname : tempNickname,
                tempPassword : tempPassword
            }),
            headers: {
                "Content-Type": "application/json",
                'X-CSRF-Token': token  // 필수! 안 해주면 "403 forbidden" 오류
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.result === "success") {
                    switch (commentValidMethod) {
                        case "check":
                            // 유효성 체크만
                            nonCreateCommentModifyForm(event, content); // 수정 form 보이게 설정
                            nonClearCommentModifyForm();                // toast 창 숨겨줌
                            break;
                        case "delete":
                            // 유효성 체크 후 삭제
                            alert("댓글이 삭제되었습니다.");
                            location.reload();
                            break;
                        default :
                            alert("잘못된 접근입니다.");
                    }
                } else if (data.result === "failure") {
                    alert("비밀번호가 틀렸습니다.");
                    return;
                }
            })
            .catch(err => {
                alert(err);
            });
    }
</script>