
<html
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:th="http://thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        layout:decorate="~{layout}">
<head>
    <link rel="stylesheet" type="text/css" href="/styles/snsIcon/snsIcon.css"> <!-- sns공유하기 -->
    <script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>  <!-- 카카오sns 공유하기 -->
</head>
<div layout:fragment="content" class="main-content-container container-fluid px-4">


    <!--/*결과 데이터 그래프가 들어올 자리*/-->
    <h1>결과 페이지</h1>
    <hr>
    게시글 제목 :[[${article.title}]]
    <br>
    게시글 내용 : [[${article.content}]]
    <hr>

    <button type="button" id="shareTw" class="link-icon twitter"></button>
    <button type="button" id="shareFb" class="link-icon facebook"></button>
    <button type="button" id="shareKt" class="link-icon kakao"></button>
    <button type="button" id="shareKs" class="link-icon kakaoStory"></button>
    <!--/*    댓글 start   */-->
    <div class="col-lg-8 col-md-12 col-sm-12 mb-4">
        <div th:text="|댓글(${commentList.totalElements})|" class="p-1 text-large" style="font-size:1.25rem">0</div>
        <div class="card card-small blog-comments">
            <!--/*    댓글 form start*/-->
            <div class="card-header border-bottom">
                <!--/*   회원용 댓글 form*/-->
                <form sec:authorize="isAuthenticated()" th:action="@{|/comment/create/${article.getId()}|}" th:object="${commentForm}" method="post">
                    <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
                        <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
                    </div>
                    <div>
                        <label for="content" class="form-label m-0 pl-1">내용</label>
                        <textarea th:field="*{content}" class="form-control comment-form" onkeydown='counter()' rows="3" placeholder="내용을 입력하세요." ></textarea>
                        <span class="float-right text-muted">(0/200)</span>
                    </div>
                    <input type="submit" th:value="저장하기" class="btn btn-primary btn-block font-weight-bold my-1"/>
                </form>
                <!--/*   비회원용 댓글 form*/-->
                <form sec:authorize="isAnonymous()" th:action="@{|/comment/non-create/${article.getId()}|}" th:object="${nonMemberCommentForm}" method="post">
                    <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
                        <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
                    </div>
                    <div class="mb-2">
                        <label for="tempNickname" class="form-label m-0 pl-1">임시 닉네임</label>
                        <input type="name" class="form-control" name="tempNickname" id="tempNickname" placeholder="닉네임">
                    </div>
                    <div class="mb-3">
                        <label for="tempPassword" class="form-label m-0 pl-1">임시 비밀번호</label>
                        <input type="password" class="form-control" name="tempPassword" id="tempPassword" placeholder="비밀번호">
                    </div>
                    <div>
                        <label for="content" class="form-label m-0 pl-1">내용</label>
                        <textarea th:field="*{content}" id="content" class="form-control comment-form" onkeydown='counter()' rows="3" placeholder="내용을 입력하세요." ></textarea>
                        <span class="float-right text-muted">(0/200)</span>
                    </div>
                    <input type="submit" th:value="저장하기" class="btn btn-primary btn-block font-weight-bold my-1"/>
                </form>
            </div>
            <!--/*    댓글 form end*/-->
            <div th:each="comment : ${commentList}" class="card-body p-0">
                <div class="blog-comments__item  p-3">
                    <div class="blog-comments__avatar d-flex justify-content-between mr-3">
                        <div class="item d-flex">
                            <!--/*회원 비회원 공통 부분 start*/-->
                            <div th:if="${comment.author != null}" th:text="${comment.author.getNickname()}" class="font-weight-bold">익명</div>
                            <div th:if="${comment.tempNickname != null}" th:text="${comment.getTempNickname()}" class="font-weight-bold">익명</div>
                            <div th:text="${#temporals.format(comment.getCreatedDate, 'yyyy-MM-dd HH:mm:ss')}" class="small text-muted ml-2 mt-1">1 분전</div>
                            <div th:text="${comment.getModifiedDate()}" class="d-none"></div>

                            <!--/*  추천 start*/-->
                            <th:block th:if="${#authentication.name != 'anonymousUser'}">
                                <th:block th:if="${#sets.contains(votedComments, comment)}">
                                    <a href="javascript:void(0);" th:myId="${comment.id}" th:onclick="pushVoteBtn(event, this.getAttribute('myId'))" type="button" class="material-icons text-dark  ml-2 px-1 float-right">
                                        thumb_up_alt
                                    </a>
                                </th:block>
                                <th:block th:unless="${#sets.contains(votedComments, comment)}">
                                    <a href="javascript:void(0);" th:myId="${comment.id}" th:onclick="pushVoteBtn(event, this.getAttribute('myId'))" type="button" class="material-icons text-dark  ml-2 px-1 float-right">
                                        thumb_up_off_alt
                                    </a>
                                </th:block>
                            </th:block>
                            <th:block th:if="${#authentication.name == 'anonymousUser'}">
                                <a href="javascript:void(0);" th:myId="${comment.id}" th:onclick="pushVoteBtn(event, this.getAttribute('myId'))" type="button" class="material-icons text-dark  ml-2 px-1 float-right">
                                    thumb_up_off_alt
                                </a>
                            </th:block>
                            <!--/*  추천 End*/-->
                            <span th:text="${#sets.size(comment.votes)}">0</span>
                            <!--/*회원 비회원 공통 부분 end*/-->
                            <!--/*회원이 보는 댓글 버튼 start*/-->
                            <div th:if="${comment.author != null}" class="d-inline">
                                <a th:if="${#authentication.name == comment.author.getMemberId()}" href="javascript:void(0);" th:myContent="${comment.content}" th:onclick="createCommentModifyForm(event, this.getAttribute('myContent'))"  type="button" class="btn-link pl-1">
                                    <span class="text-success">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    수정
                                </a>
                                <a th:if="${#authentication.name == comment.author.getMemberId()}" th:href="@{|/comment/delete/${comment.id}|}" type="button" class="btn-link">
                                    <span class="text-light">
                                        <i class="material-icons">delete</i>
                                    </span>
                                    삭제
                                </a>
                            </div>
                            <!--/*회원이 보는 댓글 버튼 end*/-->
                            <!--/*비회원이 보는 댓글 버튼 start*/-->
                            <div th:if="${#authentication.name == 'anonymousUser'}" class="d-inline">
                                <a href="javascript:void(0);" th:onclick="createCommentValidForm(event, 'check')" class="btn-link pl-1" >
                                    <span class="text-success">
                                        <i class="material-icons">edit</i>
                                    </span>
                                    수정
                                </a>
                                <a href="javascript:void(0);" type="button" th:onclick="createCommentValidForm(event, 'delete')" class="btn-link"  >
                                    <span class="text-light">
                                        <i class="material-icons">delete</i>
                                    </span>
                                    삭제
                                </a>
                                <!--/*-->
                                        ==========================
                                               toast layout
                                        ==========================
                                <!--*/-->
                                <div class="toast-valid d-none bg-success position-absolute p-1 rounded shadow-sm">
                                    <div>
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" disabled/>
                                        <input type="hidden" name="tempNickname" th:value="${comment.tempNickname}" disabled/>
                                        <input type="password" name="tempPassword" value="" placeholder="비밀번호를 입력해주세요" class="form-control-sm input-sm" required>
                                    </div>
                                    <div class="btn-group-sm mt-1  float-right">
                                        <button type="button" class="btn btn-secondary border-0" th:myContent="${comment.content}" th:myId="${comment.id}" th:onclick="sendCommentValidForm(event, this.getAttribute('myContent'),this.getAttribute('myId'))">
                                            확인
                                        </button>
                                        <button type="button" onclick="nonClearCommentModifyForm()" class="btn btn-secondary border-0 text-center">취소</button>
                                    </div>
                                </div>
                            </div>
                            <!--/*비회원이 보는 댓글 버튼 end*/-->
                        </div>
                        <!--/*-->
                                ==========================
                                           신고
                                ==========================
                        <!--*/-->
                        <div class="item">
                            <!--/*비회원 댓글 모두 신고 표시*/-->
                            <button th:if="${comment.author == null}" type="button" class="btn btn-white btn-sm">
                                    <span class="text-danger">
                                        <i class="material-icons">report</i>
                                    </span>
                                    신고
                            </button>
                            <!--/*회원 댓글 중 본인 제외하고 모두 신고 표시*/-->
                            <th:block th:unless="${comment.author == null}">
                                <button th:if="${#authentication.name != comment.author.getMemberId()}" type="button" class="btn btn-white btn-sm">
                                    <span class="text-danger">
                                        <i class="material-icons">report</i>
                                    </span>
                                    신고
                                </button>
                            </th:block>
                        </div>
                    </div>
                    <!--/*-->
                            ==========================
                                    댓글 수정 폼
                            ==========================
                    <!--*/-->
                    <div class="blog-comments__content ml-3">
                        <!--/*회원 댓글 수정폼*/-->
                        <form th:if="${#authentication.name != 'anonymousUser'}" th:action="@{|/comment/modify/${comment.id}|}" method="post">
                            <p class="m-0 my-1 mb-2 font-weight-light" >[[${comment.content}]]</p>
                        </form>
                        <!--/*비회원 댓글 수정폼*/-->
                        <form th:if="${#authentication.name == 'anonymousUser'}" th:action="@{|/comment/non-modify/${comment.id}|}" method="post" novalidate>
                            <p class="m-0 my-1 mb-2 font-weight-light" >[[${comment.content}]]</p>
                        </form>
                    </div>
                </div>
            </div>
            <!--/*-->
            ==========================
                    댓글 페이징
            ==========================
            <!--*/-->
            <div class="card-footer border-top">
                <div class="row">
                    <div class="col text-center view-report">
                        <!-- 페이징처리 시작 -->
                        <div th:if="${!commentList.isEmpty()}">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${!commentList.hasPrevious} ? 'disabled'" >
                                    <a class="page-link"
                                       th:href="@{|?page=0|}">
                                        <span class="text-primary">
                                            <i class="material-icons">first_page</i>
                                        </span>
                                    </a>
                                </li>
                                <li class="page-item" th:classappend="${!commentList.hasPrevious} ? 'disabled'">
                                    <a class="page-link"
                                       th:href="@{|?page=${commentList.number-1}|}">
                                        <span class="text-primary" >
                                            <i class="material-icons">keyboard_arrow_left</i>
                                        </span>
                                    </a>
                                </li>
                                <li th:each="page: ${#numbers.sequence(0, commentList.totalPages-1)}"
                                    th:if="${page >= commentList.number-5 and page <= commentList.number+5}"
                                    th:classappend="${page == commentList.number} ? 'active'"
                                    class="page-item">
                                    <a th:text="${page}" class="page-link" th:href="@{|?page=${page}|}"></a>
                                </li>
                                <li class="page-item" th:classappend="${!commentList.hasNext} ? 'disabled'">
                                    <a class="page-link" th:href="@{|?page=${commentList.number+1}|}">
                                        <span class="text-primary" >
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </span>
                                    </a>
                                </li>
                                <li class="page-item" th:classappend="${!commentList.hasNext} ? 'disabled'" >
                                    <a class="page-link"
                                       th:href="@{|?page=${commentList.totalPages-1}|}">
                                        <span class="text-primary" >
                                            <i class="material-icons">last_page</i>
                                        </span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <!-- 페이징처리 끝 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/*    댓글 end    */-->
</div>
</html>

<script>
    const btnShareTw = document.querySelector('#shareTw');

    btnShareTw.addEventListener('click', () => {
        const pageUrl = 'www.daum.net'; // 우리 도메인으로 변경해야 됨
        window.open(`https://twitter.com/intent/tweet?url=${pageUrl}`);
    })
    const btnShareFb = document.querySelector('#shareFb');

    btnShareFb.addEventListener('click', () => {
        const pageUrl = 'www.daum.net'; // 우리 도메인으로 변경해야 됨
        window.open(`http://www.facebook.com/sharer/sharer.php?u=${pageUrl}`);
    })


    // 카카오 스토리 공유하기 -
    Kakao.init('242f01a3af5936797443874ee2bff51c');
    const btnShareKs = document.querySelector('#shareKs');

    btnShareKs.addEventListener('click', () => {
        console.log("aa");
        Kakao.Story.share({
            url: 'www.daum.net', // 우리 도메인으로 변경해야 됨
            text: '카카오스토리로 공유 합니다.'
        });
    })
    // 카카오톡 공유하기
    Kakao.Link.createDefaultButton({
        container: '#shareKt',
        objectType: 'feed',
        content: {
            title: '나의 자질구레한 고민들',
            description: '나의 자질구레한 고민들의 투표 결과입니다.',
            imageUrl: 'http://eomcheon.com/images/main.jpg',
            link: {
                mobileWebUrl: 'http://eomcheon.com/index.php',
                webUrl: 'http://eomcheon.com/index.php'
            }
        },
    });
</script>

<script th:inline="javascript">

    // 글자 수 체크
    function counter() {
        let content = document.querySelector('.comment-form');
        let value = content.value;
        if (value.length >200) {
            value = value.substring(0,199);
            content.value = value;
        }
        content.nextElementSibling.innerHTML =  '(' + value.length +'/200)';
    }

    /**
     *  댓글 좋아요
     */
    function pushVoteBtn(event, commentId) {

        if(![[${#authentication.name != 'anonymousUser'}]]) {
            alert("로그인 후 이용해주세요");
            return false;
        }

        fetch(`/comment/vote/${commentId}`, {
            headers: {
                "Content-Type": "application/json",
            }
            })
            .then(res => {
                if (res.url === "http://localhost:8080/member/login"){
                    location.href = "http://localhost:8080/member/login";
                }
                return res.json();
            })
            .then(data => {
                if (data.result === "success") {
                    const voteBtn = event.target;
                    if(voteBtn.innerText === "thumb_up_alt") {
                        // 좋아요 된 상태라면 취소
                        voteBtn.innerText = "thumb_up_off_alt";
                        voteBtn.nextElementSibling.innerText--;
                    } else {
                        // 좋아요가 안 된 상태라면 추가
                        voteBtn.innerText = "thumb_up_alt";
                        voteBtn.nextElementSibling.innerText++;
                    }
                } else if (data.result === "failure") {
                    alert("자신의 댓글에는 추천할 수 없습니다.");
                    return;
                }
            })
            .catch(err => {
                alert(err);
            });
    }
    /**
     *  [회원] 관련 이벤트 코드
     */
    // 수정 form 내용물
    const commentModifyLayout = `<div id='modify-from-group' class='form-group p-absolute'>
                                <textarea class='form-control' name='content' rows='3' required></textarea>
                                <input type='submit' class='mb-2 btn btn-sm btn-primary mr-1 mt-1' value='수정완료'/>
                                <button type='button' class='mb-2 btn btn-sm btn-secondary mr-1 mt-1' onclick='clearCommentModifyForm()' >취소</button>
                              </div>`;
    const commentModifyTag = document.createElement('div');
    commentModifyTag.innerHTML = commentModifyLayout;

    let commentModifyBtn = '';      // 댓글 수정 버튼 태그
    let commentContentElement = ''; // 이전 댓글 내용

    // 댓글 수정 버튼 이벤트
    function createCommentModifyForm(event, content) {

        if (commentModifyBtn !== '') {
            // 이전 수정 버튼 보이게 설정
            commentModifyBtn.classList.remove('d-none');
        }

        if (commentContentElement !== '') {
            // 이전 수정 버튼 보이게 설정
            commentContentElement.classList.remove('d-none');
        }

        commentModifyBtn = event.target.closest('a');   // 수정 버튼
        commentModifyBtn.classList.toggle('d-none');    // 수정 버튼 숨김

        commentModifyTag.querySelector('.form-control').innerHTML = content;                                // textarea에 내용 넣어줌
        const commentModifyForm = commentModifyBtn.closest('.blog-comments__item').children[1].children[0]; // form 태그 가져오기
        commentModifyForm.children[1].classList.add("d-none");                                              // p태그 내용 안 보이게 설정
        commentContentElement = commentModifyForm.children[1];                                              // 임시로 p 태그 넣어줌
        commentModifyForm.append(commentModifyTag);                                                         // form 위치에 form 내용물 추가
    }
    // 댓글 수정폼 취소 버튼 이벤트
    function clearCommentModifyForm() {
        commentContentElement ='';
        commentModifyBtn.classList.remove('d-none');                        // 수정 버튼 다시 보이게
        commentModifyTag.previousElementSibling.classList.toggle('d-none'); // p태그 다시 보이게
        commentModifyTag.remove();                                          // form 제거
    }

    /**
     * [비회원] 관련 이벤트 코드
     */
    let commentValidToast = ''; // toast 태그
    let commentValidMethod =''; // 수정 or 삭제 변수

    // 댓글 수정 버튼 이벤트
    function createCommentValidForm(event, method) {

        commentValidMethod = method;

        if (commentValidToast !== '') {
            // 이전 toast창 안 보이게 설정
            commentValidToast.classList.add('d-none');
        }

        commentValidToast = event.target.closest('div').lastElementChild  // toast창 가져옴
        commentValidToast.classList.toggle('d-none')                      // toast창 보이게 설정

        // 버튼 위치 조절
        if (method === 'delete') {
            commentValidToast.classList.add('ml-5')
        } else {
            commentValidToast.classList.remove('ml-5')
        }
    }

    // 비회원 수정 폼 생성
    function nonCreateCommentModifyForm(event, content) {

        if (commentModifyBtn !== '') {
            // 이전 수정버튼 보이게 설정
            commentModifyBtn.classList.remove('d-none');
        }

        if (commentContentElement !== '') {
            // 이전 댓글 내용 보이게 설정
            commentContentElement.classList.remove('d-none');
        }
        commentModifyBtn = event.target.closest('.d-inline').firstElementChild  // 수정 버튼 가져옴
        commentModifyBtn.classList.toggle('d-none');                            // 수정 버튼 안 보이게 설정

        // createCommentModifyForm메서드와 동일
        commentModifyTag.querySelector('.form-control').innerHTML = content;
        const commentModifyForm = commentModifyBtn.closest('.blog-comments__item').children[1].children[0];
        commentModifyForm.children[1].classList.add("d-none");
        commentContentElement = commentModifyForm.children[1];
        commentModifyForm.append(commentModifyTag);
    }
    // toast 창 취소 버튼 이벤트
    function nonClearCommentModifyForm() {
        commentValidToast.classList.add('d-none');
    }
    // toast 창 확인 버튼 이벤트
    function sendCommentValidForm(event, content, commentId) {
        if (commentValidMethod === ''){
            return;
        }
        const validForm = event.target.closest('.toast-valid').firstElementChild;  // toast form 가져옴
        const token = validForm.children[0].value;                                 // token 값 가져옴
        const tempNickname = validForm.children[1].value;                          // tempNickname 값 가져옴
        const tempPassword = validForm.children[2].value;                          // tempPassword 값 가져옴

        if (tempPassword == '') {
            alert('비밀번호를 입력세주세요');
            return;
        }
        // method 여부에 따라서 check 또는 delete 요청을 보낸다.
        fetch(`/comment/non-${commentValidMethod}/${commentId}`, {
            // credentials: 'include',
            method: "POST",
            body : JSON.stringify({
                tempNickname : tempNickname,
                tempPassword : tempPassword
            }),
            headers: {
                "Content-Type": "application/json",
                'X-CSRF-Token': token  // 필수! 안 해주면 "403 forbidden" 오류
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.result === "success") {
                    switch (commentValidMethod) {
                        case "check":
                            // 유효성 체크만
                            nonCreateCommentModifyForm(event, content); // 수정 form 보이게 설정
                            nonClearCommentModifyForm();                // toast 창 숨겨줌
                            break;
                        case "delete":
                            // 유효성 체크 후 삭제
                            alert("댓글이 삭제되었습니다.");
                            location.reload();
                            break;
                        default :
                            alert("잘못된 접근입니다.");
                    }
                } else if (data.result === "failure") {
                    alert("비밀번호가 틀렸습니다.");
                    return;
                }
            })
            .catch(err => {
                alert(err);
            });
    }
</script>